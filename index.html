<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Rekap Tunggakan ULP Tulung</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<style>
body{background:#f4f6f9; font-family: sans-serif;}
.clickable{cursor:pointer; user-select: none;}
tr:hover{background:#eef3ff}
.table-responsive { overflow-x: auto; }
.card.highlight { border: 2px solid #0d6efd; box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
.card-body p { margin-bottom: 2px; line-height: 1.2; font-size: 0.85rem; }
</style>
</head>
<body>
<div class="container my-3">
<ul class="nav nav-tabs mb-3">
  <li class="nav-item"><a class="nav-link active" id="tab-lembar1" onclick="loadSheet('lembar1')">Lembar 1</a></li>
  <li class="nav-item"><a class="nav-link" id="tab-lembar2" onclick="loadSheet('lembar2')">Lembar 2</a></li>
  <li class="nav-item"><a class="nav-link" id="tab-lembar3" onclick="loadSheet('lembar3')">Lembar 3</a></li>
</ul>
<h4 class="text-center text-primary mb-3">âš¡ Rekap Tunggakan ULP Tulung</h4>
<button id="backBtn" class="btn btn-secondary btn-sm mb-2 d-none">â¬… Kembali</button>
<div id="view"></div>
</div>

<script>
const { jsPDF } = window.jspdf;
const SHEETS = {
  lembar1: {url: "https://docs.google.com/spreadsheets/d/e/2PACX-1vR0oO36v0vrge07HwX1zLsrGfuUxElZ3becef4DFHLNxsz2Lrohya5oThpvmkjzsNBF3_9hSdq0q4Ko/pub?gid=354207978&single=true&output=csv"},
  lembar2: {url: "https://docs.google.com/spreadsheets/d/e/2PACX-1vR0oO36v0vrge07HwX1zLsrGfuUxElZ3becef4DFHLNxsz2Lrohya5oThpvmkjzsNBF3_9hSdq0q4Ko/pub?gid=311394824&single=true&output=csv"},
  lembar3: {url: "https://docs.google.com/spreadsheets/d/e/2PACX-1vR0oO36v0vrge07HwX1zLsrGfuUxElZ3becef4DFHLNxsz2Lrohya5oThpvmkjzsNBF3_9hSdq0q4Ko/pub?gid=654408403&single=true&output=csv"}
};

let allData = [], currentDetail = [], currentTitle = "", currentPetugas = "Semua", currentSheet = "lembar1";
let historyStack = [], sortState = { key: null, asc: true };

const parseIDR = (val) => {
  if (!val) return 0;
  let clean = String(val).replace(/[^0-9,-]/g, '').split(',')[0];
  return parseFloat(clean) || 0;
};

// Fungsi konversi Tanggal DD-MM-YYYY ke Object Date untuk sorting akurat
const parseDate = (str) => {
  if (!str || str === "-") return new Date(0);
  const parts = str.split('-');
  return new Date(parts[2], parts[1] - 1, parts[0]);
};

const isLunas = r => r.tgl_lunas && r.tgl_lunas.trim() !== "" && r.tgl_lunas !== "-";

function loadSheet(k) {
  currentSheet = k; historyStack = []; currentPetugas = "Semua"; backBtn.classList.add("d-none");
  document.querySelectorAll(".nav-link").forEach(t => t.classList.remove("active"));
  document.getElementById("tab-" + k).classList.add("active");
  fetch(SHEETS[k].url).then(r => r.text()).then(csv => {
    allData = Papa.parse(csv, {header: true, skipEmptyLines: true}).data;
    renderPetugas();
  });
}

function pushView(fn) {
  if (historyStack.length === 0 || historyStack[historyStack.length - 1] !== fn) historyStack.push(fn);
  backBtn.classList.remove("d-none");
}

backBtn.onclick = () => {
  if (historyStack.length > 0) historyStack.pop()();
  if (historyStack.length === 0) { backBtn.classList.add("d-none"); renderPetugas(); }
};

/* ================= WA MESSAGE (IDENTIK PDF TUL VI-01) ================= */
function waMessage(r) {
  const date = new Date();
  const nBulanFull = ["JANUARI", "FEBRUARI", "MARET", "APRIL", "MEI", "JUNI", "JULI", "AGUSTUS", "SEPTEMBER", "OKTOBER", "NOVEMBER", "DESEMBER"];
  const nBulanShort = ["JAN", "FEB", "MAR", "APR", "MEI", "JUN", "JUL", "AGU", "SEP", "OKT", "NOP", "DES"];
  const blnIni = `${nBulanShort[date.getMonth()]}-${date.getFullYear()}`;
  const blnLalu = date.getMonth() === 0 ? `DES-${date.getFullYear()-1}` : `${nBulanShort[date.getMonth()-1]}-${date.getFullYear()}`;
  let periode = (currentSheet === 'lembar1') ? `${blnIni} s/d ${blnIni} (1 LEMBAR)` : `${blnLalu} s/d ${blnIni} (2 LEMBAR)`;

  const txt = `*PT. PLN (PERSERO) UID JAWA TENGAH DAN DIY*
*UP3 KLATEN*
*ULP TULUNG*

*PEMBERITAHUAN PELAKSANAAN PEMUTUSAN SEMENTARA SAMBUNGAN TENAGA LISTRIK*
----------------------------------------------------------------------
*Kepada Yth.*
*Nama* : ${r.nama}
*ID. Pelanggan* : ${r.idpel}
*Alamat* : ${r.alamat || '-'}
*Nomor Meter* : -
*Nama Gardu/Tiang* : -
*Tarip / Daya* : ${r.tarif} / ${r.daya}
*Koked* : ${r.koked}

*Rekening* : ${periode}
*Rp.* : ${parseIDR(r.rptag).toLocaleString("id-ID")}
*Jumlah Biaya Keterlambatan s.d bulan : ${blnIni}*
*Rp.* : ${parseIDR(r.rpbk).toLocaleString("id-ID")}

*Jumlah Tunggakan (belum termasuk biaya Administrasi)*
*Rp.* : *${parseIDR(r.jumlah).toLocaleString("id-ID")}*

Dengan ini diberitahukan dengan hormat bahwa pada hari ini aliran listrik di rumah/alamat seperti tersebut diatas terpaksa diputus untuk sementara karena rekening listrik belum dilunasi pada waktu yang telah ditetapkan.

Penyambungan kembali akan dilakukan pada setiap hari jam kerja apabila rekening serta biaya keterlambatan dilunasi di tempat penerimaan pembayaran rekening listrik, kantor pos, atau bank yang ditunjuk oleh PLN.

*UNTUK MENGHINDARI RESIKO, MOHON TIDAK TITIP PEMBAYARAN REKENING KEPADA PETUGAS*

TULUNG, ${date.getDate()} ${nBulanFull[date.getMonth()]} ${date.getFullYear()}
*MANAGER*
*MARTONO AJI PRABOWO*

_ABAIKAN PEMBERITAHUAN INI JIKA SUDAH MEMBAYAR TAGIHAN_`;
  return encodeURIComponent(txt);
}

/* ================= CREATE PDF ================= */
function createPDF(r) {
  const doc = new jsPDF();
  const date = new Date();
  const nBulanFull = ["JANUARI", "FEBRUARI", "MARET", "APRIL", "MEI", "JUNI", "JULI", "AGUSTUS", "SEPTEMBER", "OKTOBER", "NOVEMBER", "DESEMBER"];
  const nBulanShort = ["JAN", "FEB", "MAR", "APR", "MEI", "JUN", "JUL", "AGU", "SEP", "OKT", "NOP", "DES"];
  const blnIni = `${nBulanShort[date.getMonth()]}-${date.getFullYear()}`;
  const blnLalu = date.getMonth() === 0 ? `DES-${date.getFullYear()-1}` : `${nBulanShort[date.getMonth()-1]}-${date.getFullYear()}`;
  let periode = (currentSheet === 'lembar1') ? `${blnIni} s/d ${blnIni} (1 LEMBAR)` : `${blnLalu} s/d ${blnIni} (2 LEMBAR)`;
  
  doc.setFontSize(9);
  doc.text("PT. PLN (PERSERO) UID JAWA TENGAH DAN DIY", 15, 15);
  doc.text("UP3 KLATEN / ULP TULUNG", 15, 20);
  doc.setFont(undefined, 'bold');
  doc.text("PEMBERITAHUAN PELAKSANAAN PEMUTUSAN SEMENTARA SAMBUNGAN TENAGA LISTRIK", 105, 30, {align:"center"});
  doc.setFont(undefined, 'normal');
  doc.text("---------------------------------------------------------------------------------------------------------------------------------", 105, 33, {align:"center"});
  
  doc.text("Kepada Yth.", 15, 40);
  doc.text(`Nama : ${r.nama}`, 15, 45);
  doc.text(`ID. Pelanggan : ${r.idpel}`, 15, 50);
  doc.text(`Alamat : ${r.alamat || '-'}`, 15, 55);
  doc.text(`Tarip / Daya : ${r.tarif} / ${r.daya}`, 15, 60);
  doc.text(`Koked : ${r.koked}`, 120, 50);

  doc.text(`Rekening : ${periode}`, 15, 70);
  doc.text(`Rp. :`, 130, 70); doc.text(parseIDR(r.rptag).toLocaleString("id-ID"), 180, 70, {align:"right"});
  doc.text(`Biaya Keterlambatan s.d bulan : ${blnIni}`, 15, 75);
  doc.text(`Rp. :`, 130, 75); doc.text(parseIDR(r.rpbk).toLocaleString("id-ID"), 180, 75, {align:"right"});
  
  doc.setFont(undefined, 'bold');
  doc.text(`Jumlah Tunggakan (belum termasuk biaya Administrasi)`, 15, 82);
  doc.text(`Rp. :`, 130, 82); doc.text(parseIDR(r.jumlah).toLocaleString("id-ID"), 180, 82, {align:"right"});
  
  doc.setFont(undefined, 'normal'); doc.setFontSize(8);
  let msg = doc.splitTextToSize("Dengan ini diberitahukan dengan hormat bahwa pada hari ini aliran listrik di rumah/alamat seperti tersebut diatas terpaksa diputus untuk sementara karena rekening listrik belum dilunasi pada waktu yang telah ditetapkan. Penyambungan kembali akan dilakukan pada setiap hari jam kerja apabila rekening serta biaya keterlambatan dilunasi di tempat penerimaan pembayaran resmi.", 180);
  doc.text(msg, 15, 90);

  doc.setFont(undefined, 'bold');
  doc.text("UNTUK MENGHINDARI RESIKO, MOHON TIDAK TITIP PEMBAYARAN KEPADA PETUGAS", 15, 110);
  doc.text(`TULUNG, ${date.getDate()} ${nBulanFull[date.getMonth()]} ${date.getFullYear()}`, 140, 120);
  doc.text("MANAGER", 150, 125);
  doc.text("MARTONO AJI PRABOWO", 140, 145);
  doc.save(`TUL_${r.idpel}.pdf`);
}

/* ================= RENDER DATA & SORTING TANGGAL ================= */
function renderPetugas() {
  const map = {}; let totalRp = 0;
  allData.forEach(r => {
    let pName = r.petugas || "Tanpa Nama";
    map[pName] = map[pName] || {j: 0, rp: 0};
    map[pName].j++; map[pName].rp += parseIDR(r.jumlah); totalRp += parseIDR(r.jumlah);
  });
  const sorted = Object.keys(map).sort().map(p => ({name: p, ...map[p]}));
  let h = `<div class="table-responsive"><table class="table table-bordered"><thead class="table-dark"><tr><th>Petugas</th><th>Jml</th><th>Total Rp</th></tr></thead><tbody><tr class="table-primary clickable" onclick="openGlobal()"><td><b>SEMUA</b></td><td><b>${allData.length}</b></td><td class="text-end"><b>${totalRp.toLocaleString("id-ID")}</b></td></tr>`;
  sorted.forEach(p => { h += `<tr class="clickable" onclick="openPetugas('${p.name}')"><td>${p.name}</td><td>${p.j}</td><td class="text-end">${p.rp.toLocaleString("id-ID")}</td></tr>`; });
  view.innerHTML = h + `</tbody></table></div>`;
}

function openPetugas(p) {
  currentPetugas = p; pushView(renderPetugas);
  const data = allData.filter(r => r.petugas === p);
  const lunas = data.filter(isLunas), belum = data.filter(r => !isLunas(r)), byDate = {};
  lunas.forEach(r => { byDate[r.tgl_lunas] = byDate[r.tgl_lunas] || {j: 0, rp: 0}; byDate[r.tgl_lunas].j++; byDate[r.tgl_lunas].rp += parseIDR(r.jumlah); });
  
  let h = `<h6 class="text-primary fw-bold">Petugas: ${p}</h6><div class="table-responsive"><table class="table table-sm table-bordered"><thead class="table-success"><tr><th>Tanggal</th><th>Plg</th><th>Total Rp</th></tr></thead><tbody>`;
  if (belum.length > 0) h += `<tr class="clickable" onclick="detailBelum()"><td>BELUMLUNAS</td><td>${belum.length}</td><td class="text-end">${belum.reduce((a,b)=>a+parseIDR(b.jumlah),0).toLocaleString("id-ID")}</td></tr>`;
  
  // URUTAN TANGGAL FIX (Terbaru ke Terlama)
  Object.keys(byDate).sort((a,b) => parseDate(b) - parseDate(a)).forEach(t => { 
    h += `<tr class="clickable" onclick="detailLunas('${t}')"><td>${t}</td><td>${byDate[t].j}</td><td class="text-end">${byDate[t].rp.toLocaleString("id-ID")}</td></tr>`; 
  });
  view.innerHTML = h + `</tbody></table></div>`;
}

function openGlobal() {
  currentPetugas = "Semua"; pushView(renderPetugas);
  const lunas = allData.filter(isLunas), belum = allData.filter(r => !isLunas(r)), byDate = {};
  lunas.forEach(r => { byDate[r.tgl_lunas] = byDate[r.tgl_lunas] || {j: 0, rp: 0}; byDate[r.tgl_lunas].j++; byDate[r.tgl_lunas].rp += parseIDR(r.jumlah); });
  let h = `<h6 class="text-primary fw-bold">Semua Petugas</h6><div class="table-responsive"><table class="table table-sm table-bordered"><thead class="table-success"><tr><th>Tanggal</th><th>Plg</th><th>Total Rp</th></tr></thead><tbody>`;
  if (belum.length > 0) h += `<tr class="clickable" onclick="detailBelum()"><td>BELUMLUNAS</td><td>${belum.length}</td><td class="text-end">${belum.reduce((a,b)=>a+parseIDR(b.jumlah),0).toLocaleString("id-ID")}</td></tr>`;
  
  Object.keys(byDate).sort((a,b) => parseDate(b) - parseDate(a)).forEach(t => { 
    h += `<tr class="clickable" onclick="detailGlobalLunas('${t}')"><td>${t}</td><td>${byDate[t].j}</td><td class="text-end">${byDate[t].rp.toLocaleString("id-ID")}</td></tr>`; 
  });
  view.innerHTML = h + `</tbody></table></div>`;
}

/* FUNGSI DETAIL & CARD */
function detailLunas(t) { currentTitle = `Lunas_${t}`; currentDetail = allData.filter(r => r.petugas === currentPetugas && isLunas(r) && r.tgl_lunas === t); pushView(()=>openPetugas(currentPetugas)); renderDetail(); }
function detailBelum() { currentTitle = "Belum_Lunas"; const p = currentPetugas; currentDetail = allData.filter(r => (p === "Semua" ? true : r.petugas === p) && !isLunas(r)); pushView(()=>(p==="Semua"?openGlobal():openPetugas(p))); renderDetail(); }
function detailGlobalLunas(t) { currentTitle = `Global_Lunas_${t}`; currentDetail = allData.filter(r => isLunas(r) && r.tgl_lunas === t); pushView(openGlobal); renderDetail(); }

function renderDetail() {
  view.innerHTML = `<h6 class="text-center fw-bold small">${currentTitle.replace(/_/g,' ')}</h6><div class="d-flex mb-2 gap-1"><input id="search" class="form-control form-control-sm" placeholder="Cari..."><button class="btn btn-success btn-sm" onclick="exportExcel()">XLSX</button></div><div id="tableArea"></div>`;
  document.getElementById("search").oninput = e => {
    const t = e.target.value.toLowerCase();
    drawTable(currentDetail.filter(r => Object.values(r).some(v => String(v).toLowerCase().includes(t))));
  };
  drawTable(currentDetail);
}

function drawTable(data) {
  let h = `<div class="table-responsive"><table class="table table-sm table-bordered" style="font-size:0.7rem"><thead class="table-primary"><tr><th>IDPEL</th><th>Nama</th><th>Koked</th><th>Rp</th></tr></thead><tbody>`;
  data.forEach(r => { h += `<tr class="clickable" onclick="showCardsByData('${r.idpel}')"><td>${r.idpel}</td><td>${r.nama}</td><td>${r.koked}</td><td class="text-end">${parseIDR(r.jumlah).toLocaleString("id-ID")}</td></tr>`; });
  document.getElementById("tableArea").innerHTML = h + `</tbody></table></div>`;
}

function showCardsByData(id) {
  pushView(renderDetail);
  let h = "";
  currentDetail.forEach(r => {
    const isTarget = r.idpel === id;
    h += `<div class="card mb-2 ${isTarget?'highlight':''}" id="card-${r.idpel}"><div class="card-body p-2">
      <div class="d-flex justify-content-between"><b>${r.nama}</b> <span class="badge bg-light text-dark">${r.koked}</span></div>
      <p class="text-muted mb-1">${r.idpel} | ${r.tarif}/${r.daya} | ${r.alamat || '-'}</p>
      <div class="d-flex justify-content-between align-items-center">
        <b class="text-danger">Rp ${parseIDR(r.jumlah).toLocaleString("id-ID")}</b>
        <div class="d-flex gap-1">
          <a class="btn btn-success btn-sm" target="_blank" href="https://wa.me/?text=${waMessage(r)}">ðŸ“¤ WA</a>
          <button class="btn btn-danger btn-sm" onclick='createPDF(${JSON.stringify(r)})'>ðŸ“„ PDF</button>
        </div>
      </div>
    </div></div>`;
  });
  view.innerHTML = h;
  if(id) setTimeout(() => document.getElementById(`card-${id}`).scrollIntoView({behavior:'smooth', block:'center'}), 100);
}

function exportExcel() {
  const ws = XLSX.utils.json_to_sheet(currentDetail), wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "Data");
  XLSX.writeFile(wb, `Rekap_${currentTitle}.xlsx`);
}

loadSheet("lembar1");
</script>
</body>
</html>

