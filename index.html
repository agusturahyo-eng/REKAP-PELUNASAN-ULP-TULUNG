<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Rekap Tunggakan ULP Tulung</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>

<style>
body{background:#f4f6f9}
.clickable{cursor:pointer}
tr:hover{background:#eef3ff}
th{cursor:pointer}
</style>
</head>

<body>
<div class="container my-3">

<ul class="nav nav-tabs mb-3">
  <li class="nav-item"><a class="nav-link active" id="tab-lembar1" onclick="loadSheet('lembar1')">Lembar 1</a></li>
  <li class="nav-item"><a class="nav-link" id="tab-lembar2" onclick="loadSheet('lembar2')">Lembar 2</a></li>
  <li class="nav-item"><a class="nav-link" id="tab-lembar3" onclick="loadSheet('lembar3')">Lembar 3</a></li>
</ul>

<h4 class="text-center text-primary mb-3">âš¡ Rekap Tunggakan ULP Tulung</h4>

<button id="backBtn" class="btn btn-secondary btn-sm mb-2 d-none">â¬… Kembali</button>

<div id="view"></div>

</div>

<script>
/* ================= CONFIG ================= */
const SHEETS = {
  lembar1:{ url:"https://docs.google.com/spreadsheets/d/e/2PACX-1vR0oO36v0vrge07HwX1zLsrGfuUxElZ3becef4DFHLNxsz2Lrohya5oThpvmkjzsNBF3_9hSdq0q4Ko/pub?gid=354207978&single=true&output=csv" },
  lembar2:{ url:"https://docs.google.com/spreadsheets/d/e/2PACX-1vR0oO36v0vrge07HwX1zLsrGfuUxElZ3becef4DFHLNxsz2Lrohya5oThpvmkjzsNBF3_9hSdq0q4Ko/pub?gid=311394824&single=true&output=csv" },
  lembar3:{ url:"https://docs.google.com/spreadsheets/d/e/2PACX-1vR0oO36v0vrge07HwX1zLsrGfuUxElZ3becef4DFHLNxsz2Lrohya5oThpvmkjzsNBF3_9hSdq0q4Ko/pub?gid=654408403&single=true&output=csv" }
};

/* ================= STATE ================= */
let allData=[], currentPetugas=null, currentDetail=[], currentTitle="";
let history=[], currentSheet="lembar1";
let sortKey="", sortAsc=true;
let filteredDetail=[];

/* ================= UTIL ================= */
const isLunas = r => r.tgl_lunas && r.tgl_lunas.trim()!=="" && r.tgl_lunas!="-";

/* ================= LOAD ================= */
function loadSheet(key){
  currentSheet=key;
  history=[];
  backBtn.classList.add("d-none");
  document.querySelectorAll(".nav-link").forEach(t=>t.classList.remove("active"));
  document.getElementById("tab-"+key).classList.add("active");
  fetch(SHEETS[key].url)
    .then(r=>r.text())
    .then(csv=>{
      allData = Papa.parse(csv,{header:true,skipEmptyLines:true}).data;
      renderPetugas();
    });
}

/* ================= HISTORY ================= */
function pushView(fn){
  history.push(fn);
  backBtn.classList.remove("d-none");
}
backBtn.onclick = ()=>{
  history.pop();
  if(history.length){
    history[history.length-1]();
  }else{
    backBtn.classList.add("d-none");
    renderPetugas();
  }
};

/* ================= WA MESSAGE ================= */
function waMessage(r){
  return encodeURIComponent(`
PT. PLN (PERSERO)
UID JAWA TENGAH DAN DIY
UP3 KLATEN
ULP TULUNG

PEMBERITAHUAN PELAKSANAAN
PEMUTUSAN SEMENTARA SAMBUNGAN
TENAGA LISTRIK
=================================

Nama            : ${r.nama}
ID Pelanggan    : ${r.idpel}
Koked           : ${r.koked}
Alamat          : ${r.alamat}
Tarif / Daya    : ${r.tarif} / ${r.daya}

Jumlah Tunggakan:
Rp ${(+r.jumlah).toLocaleString("id-ID")}
(Belum termasuk biaya administrasi)

Tulung, ${new Date().toLocaleDateString("id-ID")}
PLN ULP TULUNG
`);
}

/* ================= KIRIM WA ================= */
function kirimWA(r){
  // langsung buka WA, user pilih kontak sendiri
  const url = "https://web.whatsapp.com/send?text=" + waMessage(r);
  window.open(url,"_blank");
}

/* ================= REKAP PETUGAS ================= */
function renderPetugas(){
  history=[];
  backBtn.classList.add("d-none");
  const map={};
  let totalRp=0;
  allData.forEach(r=>{
    map[r.petugas] = map[r.petugas] || {jml:0, rp:0};
    map[r.petugas].jml++;
    map[r.petugas].rp += +r.jumlah || 0;
    totalRp += +r.jumlah || 0;
  });
  let h = `<table class="table table-bordered">
  <thead class="table-dark">
  <tr><th>Petugas</th><th>Jumlah</th><th>Total Rp</th></tr>
  </thead><tbody>`;
  h += `<tr class="table-primary clickable" onclick="openGlobal()">
  <td><b>SEMUA PETUGAS</b></td>
  <td><b>${allData.length}</b></td>
  <td class="text-end"><b>${totalRp.toLocaleString("id-ID")}</b></td>
  </tr>`;
  Object.keys(map).forEach(p=>{
    h += `<tr class="clickable" onclick="openPetugas('${p}')">
    <td>${p}</td>
    <td>${map[p].jml}</td>
    <td class="text-end">${map[p].rp.toLocaleString("id-ID")}</td>
    </tr>`;
  });
  h += `</tbody></table>`;
  view.innerHTML = h;
}

/* ================= GLOBAL ================= */
function openGlobal(){
  pushView(renderPetugas);
  currentPetugas="SEMUA";
  const lunas=allData.filter(isLunas);
  const byDate={};
  lunas.forEach(r=>{
    byDate[r.tgl_lunas] = byDate[r.tgl_lunas] || {jml:0, rp:0};
    byDate[r.tgl_lunas].jml++;
    byDate[r.tgl_lunas].rp += +r.jumlah || 0;
  });
  let h=`<h6 class="text-primary">Rekap Semua Petugas</h6>
  <table class="table table-sm table-bordered mt-2">
  <thead class="table-success"><tr>
  <th>Tanggal</th><th>Pelanggan</th><th>Total Rp</th></tr></thead><tbody>`;
  Object.keys(byDate).forEach(t=>{
    h += `<tr class="clickable" onclick="detailGlobalLunas('${t}')">
    <td>${t}</td>
    <td>${byDate[t].jml}</td>
    <td class="text-end">${byDate[t].rp.toLocaleString("id-ID")}</td></tr>`;
  });
  h += `</tbody></table>`;
  view.innerHTML = h;
}

/* ================= PETUGAS ================= */
function openPetugas(p){
  pushView(renderPetugas);
  currentPetugas=p;
  const data = allData.filter(r=>r.petugas===p);
  const lunas = data.filter(isLunas);
  const byDate={};
  lunas.forEach(r=>{
    byDate[r.tgl_lunas] = byDate[r.tgl_lunas] || {jml:0, rp:0};
    byDate[r.tgl_lunas].jml++;
    byDate[r.tgl_lunas].rp += +r.jumlah || 0;
  });
  let h=`<h6 class="text-primary">Petugas: ${p}</h6>
  <table class="table table-sm table-bordered mt-2">
  <thead class="table-success"><tr>
  <th>Tanggal</th><th>Pelanggan</th><th>Total Rp</th></tr></thead><tbody>`;
  Object.keys(byDate).forEach(t=>{
    h += `<tr class="clickable" onclick="detailLunas('${t}')">
    <td>${t}</td>
    <td>${byDate[t].jml}</td>
    <td class="text-end">${byDate[t].rp.toLocaleString("id-ID")}</td></tr>`;
  });
  h += `</tbody></table>`;
  view.innerHTML = h;
}

/* ================= DETAIL ================= */
function detailLunas(t){
  pushView(()=>openPetugas(currentPetugas));
  currentTitle=`Lunas_${t}`;
  currentDetail=allData.filter(r=>r.petugas===currentPetugas && isLunas(r) && r.tgl_lunas===t);
  filteredDetail=[...currentDetail];
  renderDetailTable(`Detail Lunas ${t}`,"success");
}

function detailGlobalLunas(t){
  pushView(openGlobal);
  currentTitle=`Global_Lunas_${t}`;
  currentDetail=allData.filter(r=>isLunas(r) && r.tgl_lunas===t);
  filteredDetail=[...currentDetail];
  renderDetailTable(`Detail Lunas ${t}`,"success");
}

/* ================= TABLE + CARD ================= */
function renderDetailTable(title,color){
  let h=`<div class="mb-2">
  <h6 class="text-${color}">${title}</h6>
  <input id="searchInput" class="form-control form-control-sm w-50" placeholder="Cari..." oninput="searchDetail()">
  </div>
  <div class="table-responsive">
  <table class="table table-sm table-bordered" id="dt">
  <thead class="table-${color}">
  <tr>
  <th onclick="sortDetail('idpel')">IDPEL</th>
  <th onclick="sortDetail('nama')">Nama</th>
  <th onclick="sortDetail('alamat')">Alamat</th>
  <th onclick="sortDetail('koked')">Koded</th>
  <th onclick="sortDetail('tarif')">Tarif</th>
  <th onclick="sortDetail('daya')">Daya</th>
  <th onclick="sortDetail('jumlah')">Rp</th>
  </tr></thead><tbody id="tbodyDetail"></tbody></table></div>`;

  view.innerHTML = h;
  renderTbody(filteredDetail);
}

function renderTbody(data){
  const tbody = document.getElementById("tbodyDetail");
  tbody.innerHTML = "";
  data.forEach(r=>{
    const tr = document.createElement("tr");
    tr.className="clickable";
    tr.innerHTML=`<td>${r.idpel}</td><td>${r.nama}</td><td>${r.alamat}</td>
      <td>${r.koked}</td><td>${r.tarif}</td><td>${r.daya}</td>
      <td class="text-end">${(+r.jumlah).toLocaleString("id-ID")}</td>`;
    tr.onclick = ()=>showCards();
    tbody.appendChild(tr);
  });
}

function sortDetail(key){
  sortAsc=(sortKey===key)?!sortAsc:true;
  sortKey=key;
  currentDetail.sort((a,b)=>{
    let x=a[key]||"", y=b[key]||"";
    if(!isNaN(x) && !isNaN(y)) return sortAsc?x-y:y-x;
    return sortAsc?x.localeCompare(y):y.localeCompare(x);
  });
  filteredDetail=[...currentDetail];
  renderTbody(filteredDetail);
}

function searchDetail(){
  const q = document.getElementById("searchInput").value.toLowerCase();
  filteredDetail = currentDetail.filter(r=>
    (r.nama||"").toLowerCase().includes(q)||
    (r.idpel||"").toLowerCase().includes(q)||
    (r.alamat||"").toLowerCase().includes(q)
  );
  renderTbody(filteredDetail);
}

/* ================= CARD VIEW ================= */
function showCards(){
  pushView(()=>renderDetailTable(currentTitle));
  let h=`<h6 class="text-primary">Detail Pelanggan</h6>`;
  filteredDetail.forEach((r,i)=>{
    h+=`<div class="card mb-2">
      <div class="card-body p-2">
        <b>${r.nama}</b><br>IDPEL: ${r.idpel}<br>${r.alamat}<br>
        Koded: ${r.koked}<br>Tarif/Daya: ${r.tarif}/${r.daya}<br>
        <b>Rp ${(+r.jumlah).toLocaleString("id-ID")}</b>
        <div class="mt-2" id="btn-wa-${i}"></div>
      </div>
    </div>`;
  });
  view.innerHTML=h;
  filteredDetail.forEach((r,i)=>{
    const btn = document.createElement("button");
    btn.className="btn btn-success btn-sm";
    btn.innerText="ðŸ“¤ Kirim WhatsApp";
    btn.onclick = ()=>kirimWA(r);
    document.getElementById(`btn-wa-${i}`).appendChild(btn);
  });
}

/* ================= EXPORT ================= */
function exportExcel(){
  let table=`<table><tr>
  <th>IDPEL</th><th>Nama</th><th>Alamat</th>
  <th>Koded</th><th>Tarif</th><th>Daya</th><th>Jumlah</th>
  </tr>`;
  currentDetail.forEach(r=>{
    table+=`<tr>
    <td>${r.idpel}</td><td>${r.nama}</td><td>${r.alamat}</td>
    <td>${r.koked}</td><td>${r.tarif}</td><td>${r.daya}</td>
    <td>${r.jumlah}</td></tr>`;
  });
  table+=`</table>`;
  saveAs(new Blob([table],{type:"application/vnd.ms-excel"}),`${currentTitle}.xls`);
}

/* LOAD AWAL */
loadSheet("lembar1");
</script>
</body>
</html>









