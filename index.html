<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Rekap Tunggakan ULP Tulung</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<style>
body{background:#f4f6f9}
.clickable{cursor:pointer; user-select: none;}
tr:hover{background:#eef3ff}
.table-primary th:hover { background-color: #0d6efd !important; color: white; }
.table-responsive { overflow-x: auto; }
</style>
</head>

<body>
<div class="container my-3">

<ul class="nav nav-tabs mb-3">
  <li class="nav-item"><a class="nav-link active" id="tab-lembar1" onclick="loadSheet('lembar1')">Lembar 1</a></li>
  <li class="nav-item"><a class="nav-link" id="tab-lembar2" onclick="loadSheet('lembar2')">Lembar 2</a></li>
  <li class="nav-item"><a class="nav-link" id="tab-lembar3" onclick="loadSheet('lembar3')">Lembar 3</a></li>
</ul>

<h4 class="text-center text-primary mb-3">âš¡ Rekap Tunggakan ULP Tulung</h4>
<button id="backBtn" class="btn btn-secondary btn-sm mb-2 d-none">â¬… Kembali</button>

<div id="view"></div>
</div>

<script>
/* ================= CONFIG ================= */
const SHEETS = {
  lembar1: {url: "https://docs.google.com/spreadsheets/d/e/2PACX-1vR0oO36v0vrge07HwX1zLsrGfuUxElZ3becef4DFHLNxsz2Lrohya5oThpvmkjzsNBF3_9hSdq0q4Ko/pub?gid=354207978&single=true&output=csv"},
  lembar2: {url: "https://docs.google.com/spreadsheets/d/e/2PACX-1vR0oO36v0vrge07HwX1zLsrGfuUxElZ3becef4DFHLNxsz2Lrohya5oThpvmkjzsNBF3_9hSdq0q4Ko/pub?gid=311394824&single=true&output=csv"},
  lembar3: {url: "https://docs.google.com/spreadsheets/d/e/2PACX-1vR0oO36v0vrge07HwX1zLsrGfuUxElZ3becef4DFHLNxsz2Lrohya5oThpvmkjzsNBF3_9hSdq0q4Ko/pub?gid=654408403&single=true&output=csv"}
};

/* ================= STATE ================= */
let allData = [], currentDetail = [], currentTitle = "", currentPetugas = "Semua";
let history = [];
let sortState = { key: null, asc: true };

/* ================= UTIL ================= */
const isLunas = r => r.tgl_lunas && r.tgl_lunas.trim() !== "" && r.tgl_lunas !== "-";

/* ================= LOAD ================= */
function loadSheet(k) {
  history = [];
  currentPetugas = "Semua"; // Reset nama petugas saat ganti lembar
  backBtn.classList.add("d-none");
  document.querySelectorAll(".nav-link").forEach(t => t.classList.remove("active"));
  document.getElementById("tab-" + k).classList.add("active");

  fetch(SHEETS[k].url).then(r => r.text()).then(csv => {
    allData = Papa.parse(csv, {header: true, skipEmptyLines: true}).data;
    renderPetugas();
  });
}

/* ================= HISTORY ================= */
function pushView(fn) {
  history.push(fn);
  backBtn.classList.remove("d-none");
}
backBtn.onclick = () => {
  history.pop();
  if (history.length) {
    history.at(-1)();
  } else {
    backBtn.classList.add("d-none");
    currentPetugas = "Semua"; 
    renderPetugas();
  }
};

/* ================= WA ================= */
function waMessage(r) {
  return encodeURIComponent(`PT. PLN (PERSERO)\nUID JAWA TENGAH DAN DIY\nUP3 KLATEN\nULP TULUNG\n\nNama : ${r.nama}\nID Pelanggan : ${r.idpel}\nKoked : ${r.koked}\nAlamat : ${r.alamat}\nTarif / Daya : ${r.tarif} / ${r.daya}\n\nJumlah Tunggakan:\nRp ${(+r.jumlah).toLocaleString("id-ID")}\n\nPLN ULP TULUNG`);
}

/* ================= REKAP UTAMA ================= */
function renderPetugas() {
  history = [];
  backBtn.classList.add("d-none");
  const map = {};
  let totalRp = 0;

  allData.forEach(r => {
    let pName = r.petugas || "Tanpa Nama";
    map[pName] = map[pName] || {j: 0, rp: 0};
    map[pName].j++;
    map[pName].rp += (+r.jumlah || 0);
    totalRp += (+r.jumlah || 0);
  });

  let h = `<div class="table-responsive"><table class="table table-bordered">
  <thead class="table-dark">
  <tr><th>Petugas</th><th>Jumlah</th><th>Total Rp</th></tr>
  </thead><tbody>
  <tr class="table-primary clickable" onclick="openGlobal()">
    <td><b>SEMUA PETUGAS</b></td>
    <td><b>${allData.length}</b></td>
    <td class="text-end"><b>${totalRp.toLocaleString("id-ID")}</b></td>
  </tr>`;

  Object.keys(map).forEach(p => {
    h += `<tr class="clickable" onclick="openPetugas('${p}')">
      <td>${p}</td>
      <td>${map[p].j}</td>
      <td class="text-end">${map[p].rp.toLocaleString("id-ID")}</td>
    </tr>`;
  });
  view.innerHTML = h + `</tbody></table></div>`;
}

function openPetugas(p) {
  currentPetugas = p; // Mengunci nama petugas
  pushView(renderPetugas);
  const data = allData.filter(r => r.petugas === p);
  const lunas = data.filter(isLunas);
  const belum = data.filter(r => !isLunas(r));
  const byDate = {};

  lunas.forEach(r => {
    byDate[r.tgl_lunas] = byDate[r.tgl_lunas] || {j: 0, rp: 0};
    byDate[r.tgl_lunas].j++;
    byDate[r.tgl_lunas].rp += (+r.jumlah || 0);
  });

  let h = `<h6 class="text-primary">Petugas: ${p}</h6>
  <h6 class="text-success mt-3">Lunas per Tanggal</h6>
  <div class="table-responsive"><table class="table table-sm table-bordered">
  <thead class="table-success"><tr><th>Tanggal</th><th>Pelanggan</th><th>Total Rp</th></tr></thead><tbody>`;

  Object.keys(byDate).forEach(t => {
    h += `<tr class="clickable" onclick="detailLunas('${t}')"><td>${t}</td><td>${byDate[t].j}</td><td class="text-end">${byDate[t].rp.toLocaleString("id-ID")}</td></tr>`;
  });
  h += `</tbody></table></div>`;

  if (belum.length) {
    h += `<h6 class="mt-3 clickable text-danger" onclick="detailBelum()"><b>> Belum Lunas (${belum.length} Pelanggan)</b></h6>`;
  }
  view.innerHTML = h;
}

function openGlobal() {
  currentPetugas = "Semua_Petugas";
  pushView(renderPetugas);
  const lunas = allData.filter(isLunas);
  const byDate = {};
  lunas.forEach(r => {
    byDate[r.tgl_lunas] = byDate[r.tgl_lunas] || {j: 0, rp: 0};
    byDate[r.tgl_lunas].j++;
    byDate[r.tgl_lunas].rp += (+r.jumlah || 0);
  });

  let h = `<h6 class="text-primary">Semua Petugas</h6>
  <h6 class="text-success mt-3">Lunas per Tanggal</h6>
  <div class="table-responsive"><table class="table table-sm table-bordered">
  <thead class="table-success"><tr><th>Tanggal</th><th>Pelanggan</th><th>Total Rp</th></tr></thead><tbody>`;

  Object.keys(byDate).forEach(t => {
    h += `<tr class="clickable" onclick="detailGlobalLunas('${t}')"><td>${t}</td><td>${byDate[t].j}</td><td class="text-end">${byDate[t].rp.toLocaleString("id-ID")}</td></tr>`;
  });
  view.innerHTML = h + `</tbody></table></div>`;
}

/* ================= DETAIL LOGIC ================= */
function detailLunas(t) {
  const p = currentPetugas;
  pushView(() => openPetugas(p));
  currentTitle = `Lunas_${t}`;
  currentDetail = allData.filter(r => r.petugas === p && isLunas(r) && r.tgl_lunas === t);
  renderDetail();
}
function detailBelum() {
  const p = currentPetugas;
  pushView(() => openPetugas(p));
  currentTitle = "Belum_Lunas";
  currentDetail = allData.filter(r => r.petugas === p && !isLunas(r));
  renderDetail();
}
function detailGlobalLunas(t) {
  pushView(openGlobal);
  currentTitle = `Global_Lunas_${t}`;
  currentDetail = allData.filter(r => isLunas(r) && r.tgl_lunas === t);
  renderDetail();
}

function renderDetail() {
  sortState = { key: null, asc: true };
  view.innerHTML = `
  <h5 class="text-center">${currentTitle.replace(/_/g, ' ')}</h5>
  <div class="d-flex justify-content-between mb-2 gap-1">
    <input id="search" class="form-control form-control-sm w-50" placeholder="Cari...">
    <button class="btn btn-success btn-sm" onclick="exportExcel()">â¬‡ XLSX</button>
  </div>
  <div id="table"></div>`;

  document.getElementById("search").oninput = e => {
    const t = e.target.value.toLowerCase();
    const filtered = currentDetail.filter(r => Object.values(r).some(v => String(v).toLowerCase().includes(t)));
    drawTable(filtered);
  };
  drawTable(currentDetail);
}

function drawTable(data) {
  window.triggerSort = (key) => {
    if (sortState.key === key) sortState.asc = !sortState.asc;
    else { sortState.key = key; sortState.asc = true; }
    const sorted = [...data].sort((a, b) => {
      let v1 = a[key], v2 = b[key];
      if (key === 'jumlah') { v1 = parseFloat(v1) || 0; v2 = parseFloat(v2) || 0; }
      return sortState.asc ? (v1 > v2 ? 1 : -1) : (v1 < v2 ? 1 : -1);
    });
    drawTable(sorted);
  };

  const icon = (k) => sortState.key === k ? (sortState.asc ? ' â–²' : ' â–¼') : '';
  let h = `<div class="table-responsive"><table class="table table-sm table-bordered">
  <thead class="table-primary text-nowrap">
  <tr>
    <th class="clickable" onclick="triggerSort('idpel')">IDPEL${icon('idpel')}</th>
    <th class="clickable" onclick="triggerSort('nama')">Nama${icon('nama')}</th>
    <th class="clickable" onclick="triggerSort('alamat')">Alamat${icon('alamat')}</th>
    <th class="clickable" onclick="triggerSort('koked')">Koked${icon('koked')}</th>
    <th class="clickable" onclick="triggerSort('tarif')">Tarif/Daya${icon('tarif')}</th>
    <th class="clickable" onclick="triggerSort('jumlah')">Rp${icon('jumlah')}</th>
  </tr></thead><tbody>`;

  data.forEach(r => {
    h += `<tr class="clickable" onclick="showCardsByData('${r.idpel}')">
      <td>${r.idpel}</td><td>${r.nama}</td><td>${r.alamat}</td><td>${r.koked}</td><td>${r.tarif}/${r.daya}</td><td class="text-end">${(+r.jumlah).toLocaleString("id-ID")}</td>
    </tr>`;
  });
  document.getElementById("table").innerHTML = h + `</tbody></table></div>`;
}

function showCardsByData(id) {
  pushView(renderDetail);
  let h = `<button class="btn btn-success btn-sm mb-2" onclick="exportExcel()">â¬‡ Export XLSX</button>`;
  currentDetail.forEach(r => {
    const cls = r.idpel === id ? 'border-primary border-3 shadow' : '';
    h += `<div class="card mb-2 ${cls}"><div class="card-body p-2">
      <b>${r.nama}</b><br>IDPEL: ${r.idpel}<br>${r.alamat}<br>
      Koked: ${r.koked} | Rp ${(+r.jumlah).toLocaleString("id-ID")}<br>
      <a class="btn btn-success btn-sm mt-2" target="_blank" href="https://wa.me/?text=${waMessage(r)}">ðŸ“¤ WhatsApp</a>
    </div></div>`;
  });
  view.innerHTML = h;
  window.scrollTo(0,0);
}

/* ================= EXPORT XLSX ================= */
function exportExcel() {
  const header = ["PETUGAS", "IDPEL", "NAMA", "ALAMAT", "KOKED", "TARIF", "DAYA", "JUMLAH", "TGL LUNAS"];
  const rows = currentDetail.map(r => [
    r.petugas, r.idpel, r.nama, r.alamat, r.koked, r.tarif, r.daya, parseFloat(r.jumlah) || 0, r.tgl_lunas
  ]);
  
  const ws = XLSX.utils.aoa_to_sheet([header, ...rows]);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "Data");

  // Nama file akan menyertakan nama petugas yang tersimpan di state
  const cleanName = currentPetugas.replace(/\s+/g, '_');
  XLSX.writeFile(wb, `${cleanName}_${currentTitle}.xlsx`);
}

/* ================= INIT ================= */
loadSheet("lembar1");
</script>
</body>
</html>
