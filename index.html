<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Rekap Tunggakan ULP Tulung</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>

<style>
body{background:#f4f6f9}
.clickable{cursor:pointer}
tr:hover{background:#eef3ff}
</style>
</head>

<body>
<div class="container my-3">

<ul class="nav nav-tabs mb-3">
  <li class="nav-item"><a class="nav-link active" id="tab-lembar1" onclick="loadSheet('lembar1')">Lembar 1</a></li>
  <li class="nav-item"><a class="nav-link" id="tab-lembar2" onclick="loadSheet('lembar2')">Lembar 2</a></li>
  <li class="nav-item"><a class="nav-link" id="tab-lembar3" onclick="loadSheet('lembar3')">Lembar 3</a></li>
</ul>

<h4 class="text-center text-primary mb-3">âš¡ Rekap Tunggakan ULP Tulung</h4>
<button id="backBtn" class="btn btn-secondary btn-sm mb-2 d-none">â¬… Kembali</button>

<div id="view"></div>
</div>

<script>
/* ================= CONFIG ================= */
const SHEETS={
  lembar1:{url:"https://docs.google.com/spreadsheets/d/e/2PACX-1vR0oO36v0vrge07HwX1zLsrGfuUxElZ3becef4DFHLNxsz2Lrohya5oThpvmkjzsNBF3_9hSdq0q4Ko/pub?gid=354207978&single=true&output=csv"},
  lembar2:{url:"https://docs.google.com/spreadsheets/d/e/2PACX-1vR0oO36v0vrge07HwX1zLsrGfuUxElZ3becef4DFHLNxsz2Lrohya5oThpvmkjzsNBF3_9hSdq0q4Ko/pub?gid=311394824&single=true&output=csv"},
  lembar3:{url:"https://docs.google.com/spreadsheets/d/e/2PACX-1vR0oO36v0vrge07HwX1zLsrGfuUxElZ3becef4DFHLNxsz2Lrohya5oThpvmkjzsNBF3_9hSdq0q4Ko/pub?gid=654408403&single=true&output=csv"}
};

/* ================= STATE ================= */
let allData=[], currentDetail=[], currentTitle="";
let history=[], currentPetugas=null;

/* ================= UTIL ================= */
const isLunas=r=>r.tgl_lunas && r.tgl_lunas.trim()!=="" && r.tgl_lunas!="-";

/* ================= LOAD ================= */
function loadSheet(k){
  history=[];
  backBtn.classList.add("d-none");
  document.querySelectorAll(".nav-link").forEach(t=>t.classList.remove("active"));
  document.getElementById("tab-"+k).classList.add("active");

  fetch(SHEETS[k].url).then(r=>r.text()).then(csv=>{
    allData=Papa.parse(csv,{header:true,skipEmptyLines:true}).data;
    renderPetugas();
  });
}

/* ================= HISTORY ================= */
function pushView(fn){
  history.push(fn);
  backBtn.classList.remove("d-none");
}
backBtn.onclick=()=>{
  history.pop();
  history.length ? history.at(-1)() : (backBtn.classList.add("d-none"),renderPetugas());
};

/* ================= WA ================= */
function waMessage(r){
  return encodeURIComponent(`
PT. PLN (PERSERO)
UID JAWA TENGAH DAN DIY
UP3 KLATEN
ULP TULUNG

Nama : ${r.nama}
IDPEL : ${r.idpel}
Alamat : ${r.alamat}

Jumlah Tunggakan:
Rp ${(+r.jumlah).toLocaleString("id-ID")}

PLN ULP TULUNG
`);
}

/* ================= PETUGAS ================= */
function renderPetugas(){
  history=[];
  backBtn.classList.add("d-none");

  const map={};
  let totalRp=0;
  allData.forEach(r=>{
    map[r.petugas]=map[r.petugas]||{j:0,rp:0};
    map[r.petugas].j++;
    map[r.petugas].rp+=(+r.jumlah||0);
    totalRp+=(+r.jumlah||0);
  });

  let h=`<table class="table table-bordered">
  <thead class="table-dark"><tr><th>Petugas</th><th>Jumlah</th><th>Total Rp</th></tr></thead><tbody>
  <tr class="table-primary clickable" onclick="openGlobal()">
  <td><b>SEMUA PETUGAS</b></td><td><b>${allData.length}</b></td>
  <td class="text-end"><b>${totalRp.toLocaleString("id-ID")}</b></td></tr>`;

  Object.keys(map).forEach(p=>{
    h+=`<tr class="clickable" onclick="openPetugas('${p}')">
    <td>${p}</td><td>${map[p].j}</td>
    <td class="text-end">${map[p].rp.toLocaleString("id-ID")}</td></tr>`;
  });

  view.innerHTML=h+`</tbody></table>`;
}

/* ================= DETAIL ================= */
function renderDetail(title){
  view.innerHTML=`
  <div class="d-flex justify-content-between mb-2">
    <input class="form-control form-control-sm w-50" placeholder="Search..." id="search">
    <button class="btn btn-success btn-sm" id="btnExport">â¬‡ Export Excel</button>
  </div>
  <div id="table"></div>`;

  document.getElementById("btnExport").onclick=exportExcel;
  document.getElementById("search").oninput=e=>{
    const t=e.target.value.toLowerCase();
    drawTable(currentDetail.filter(r=>
      r.nama.toLowerCase().includes(t)||
      r.idpel.toLowerCase().includes(t)||
      r.alamat.toLowerCase().includes(t)
    ));
  };

  drawTable(currentDetail);
}

function drawTable(data){
  let h=`<table class="table table-sm table-bordered">
  <thead class="table-primary">
  <tr><th>IDPEL</th><th>Nama</th><th>Alamat</th><th>Rp</th></tr>
  </thead><tbody>`;

  data.forEach(r=>{
    h+=`<tr class="clickable" onclick="showCards()">
    <td>${r.idpel}</td><td>${r.nama}</td><td>${r.alamat}</td>
    <td class="text-end">${(+r.jumlah).toLocaleString("id-ID")}</td></tr>`;
  });

  document.getElementById("table").innerHTML=h+`</tbody></table>`;
}

/* ================= CARD ================= */
function showCards(){
  pushView(()=>renderDetail(currentTitle));
  let h=`<button class="btn btn-success btn-sm mb-2" onclick="exportExcel()">â¬‡ Export Excel</button>`;
  currentDetail.forEach(r=>{
    h+=`<div class="card mb-2"><div class="card-body p-2">
    <b>${r.nama}</b><br>IDPEL:${r.idpel}<br>${r.alamat}<br>
    <b>Rp ${(+r.jumlah).toLocaleString("id-ID")}</b><br>
    <a class="btn btn-success btn-sm mt-2" target="_blank"
    href="https://wa.me/?text=${waMessage(r)}">ðŸ“¤ Kirim WhatsApp</a>
    </div></div>`;
  });
  view.innerHTML=h;
}

/* ================= EXPORT ================= */
function exportExcel(){
  let t=`<table><tr><th>IDPEL</th><th>Nama</th><th>Alamat</th><th>Jumlah</th></tr>`;
  currentDetail.forEach(r=>{
    t+=`<tr><td>${r.idpel}</td><td>${r.nama}</td><td>${r.alamat}</td><td>${r.jumlah}</td></tr>`;
  });
  saveAs(new Blob([t+`</table>`],{type:"application/vnd.ms-excel"}),`${currentTitle}.xls`);
}

/* ================= OPEN ================= */
function openPetugas(p){
  pushView(renderPetugas);
  currentPetugas=p;
  currentDetail=allData.filter(r=>r.petugas===p);
  currentTitle=p;
  renderDetail(p);
}
function openGlobal(){
  pushView(renderPetugas);
  currentDetail=[...allData];
  currentTitle="SEMUA";
  renderDetail("SEMUA");
}

/* ================= INIT ================= */
loadSheet("lembar1");
</script>
</body>
</html>







